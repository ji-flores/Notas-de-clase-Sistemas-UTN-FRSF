# SQL (LDD y LMD)

- Lenguaje basado en el Modelo Relacional.
- Constituido en sub-lenguajes:
    - Lenguaje de definición de datos (LDD): Comandos para definir/modificar la estructura de los objetos de la BD.
    - Lenguaje de manipulación de datos (LMD): Comandos para manipular los datos de la BD.
    - Lenguaje de consulta (LC): Comandos para realizar consultas sobre la base de datos.
    - Lenguaje de control de datos (LCD): Comandos para manejar permisos en la BD.
    - Lenguaje de control de transacciones (LCT): Comandos para el manejo de transacciones.

# Lenguaje de Definición de Datos

*Incompleto, para más ver:*

[Chapter 5. Data Definition](https://www.postgresql.org/docs/current/ddl.html)

*O la diapositiva de la catedra, en Teams.*

---

- Permite definir el esquema conceptual de la BD.
- Contiene los comandos necesarios para definir o modificar la estructura de los objetos de la base de datos.
- Todas las sentencias del LDD tienen un commit automatico. Se ejecutan apenas se escriben.
- No se puede hacer un rollback de un comando.

## Crear una tabla

```sql
CREATE TABLE[esquema.]tabla
	(columna tipo_dato [DEFAULT expr] [restriccion_columna],
	 ...
	 [restriccion_tabla]);
```

esquema: Es el mismo nombre que el del propietario. Existe un esquema publico, que es el default. Si se elige este esquema cualquiera con acceso al motor de BD tendrá acceso a los datos.

tabla: Es el nombre de la tabla.

DEFAULT expr: Especifica el valor por omisión

columna: Nombre de columna

tipo_dato: Tipo de dato y longitud de la columna.

restriccion_columna: Restricción de integridad de la columna

## Restricciones

- Importantes para asegurar integridad de datos.
- Se checkean cuando se ingresa, actualiza o elimina un dato de la tabla.
- Tienen un nombre y se almacenana en el diccionario de datos.
- Se crean en el momento que se genera la tabla.
- Se pueden agregar (ALTER TABLE ADD) después de la creación de la tabla y también activar o desactivar.
- Se pueden definir a nivel de columna o de tabla.

### PRIMARY_KEY

**Sintaxis**

A nivel de columna:

`CONSTRAINT *<nombre_restr>* PRIMARY KEY`

A nivel de tabla:

`CONSTRAINT *<nombre_restr>* PRIMARY KEY (*<columna1>,...,<columnaN>*)`

Dato: Definición de claves compuestas solo se admite a nivel de tabla.

### FOREIGN_KEY

- Se pueden referenciar columnas UNIQUE *ademas* de PRIMARY_KEYs

Acciones opcionales:

[ON DELETE acción] [ON UPDATE acción]

CASACADE: Si se borra/actualiza la fila en la tabla padre, las filas dependientes en la tabla hija también serán borradas/actualizadas.

RESTRICT: La fila en la tabla padre no puede ser borrada/actualizada mientras haya referencias a ella en la tabla hija. Este es el estado por default.

SET NULL: Si se borra/actualiza la fila en la tabla padre, las columnas de las filas …

SET DEFAULT: 

### NOT_NULL

Prohibe que la coluumna admita valores nulos.

- Solo se especifica a nivel de columna.
- Por omisión las columnas admiten valores nulos.

### UNIQUE

- Define una columna o columnas como clave unica. Dos filas en la misma tabla no pueden tener el mismo valor para esta clave.
- Se permiten valores nulos.
- Se pueden definir a nivel de columna o de tabla (sobre todo para claves compuestas).

### CHECK

- Aplicar restricciones sobre los datos en forma de condiciones lógicas.

You can use a `CHECK` constraint to restrict a column to a certain set of values in SQL. The `CHECK` constraint applies a logical condition to the values in the column, and only allows values that satisfy the condition to be inserted or updated.

For example, to restrict the `gender` column in a `users` table to only allow the values 'male' or 'female', you could use the following SQL code:

```sql
ALTER TABLE users ADD CONSTRAINT gender_check CHECK (gender IN ('male', 'female'));

```

This adds a `CHECK` constraint to the `gender` column in the `users` table, which only allows the values 'male' or 'female' to be inserted or updated in the column.

## Modificar tablas

### ALTER TABLE

Modificar la estructura de las tablas.

- Agregar, modificar o eliminar columnas.
- Agregar, modificar o eliminar restricciones.

```sql
ALTER TABLE <nombre_tabla>
	ADD COLUMN 

ALTER TABLE <nombre_tabla>
	RENAME COLUMN <nombre_clmna> TO <nombre_clmna_nuevo>

RENAME TABLE <nombre_tabla> TO <nombre_tabla_nuevo>

ALTER TABLE <nombre_tabla>
	DROP COLUMN <nombre_columna> [CASCADE]???

...

ALTER TABLE
	DROP CONSTRAINT <nombre_restr> [CASCADE]

DROP TABLE <nombre_tabla> [CASCADE]
```

# Lenguaje de Modificación de Datos

**Comandos que modifican el estado de una tabla.**

Comandos principales:

- INSERT
- DELETE
- UPDATE
- COMMIT: Cualquier acción ingresada primero se recuerda en memoria, solo luego de la ejecución de este comando los cambios realmente se graban en la BD.
- ROLLBACK: La ultima acción se borra de la memoria. *Siempre que* no se haya ejecutado COMMIT.

## INSERT

```sql
INSERT INTO <tabla> VALUES (<valor_col1>,...,<valor_colN>);
/*Solo si los valores estan en orden*/
/*Ej:*/
INSERT INTO products VALUES (1, 'Cheese', 9.99);

INSERT INTO <tabla> (<col>,...,<col>) VALUES (<valor_col>,...,<valor_col>);
/*Las columnas pueden ir en cualquier orden: El que se especifica en (<col>,...,<col>)*/
/*Ej:*/
INSERT INTO products (product_no, name, price) VALUES (1, 'Cheese', 9.99);
INSERT INTO products (name, price, product_no) VALUES ('Cheese', 9.99, 1);

/*Si se quieren ingresar varias a la vez:*/
INSERT INTO products (product_no, name, price) VALUES
    (1, 'Cheese', 9.99),
    (2, 'Bread', 1.99),
    (3, 'Milk', 2.99);
```

**Nota:** Cuando se insertan muchos datos a la vez, usar comando `COPY`, que no estan flexible como `INSERT`, pero es más eficiente. *Ver sección 14.4. de la documentación de PostgreSQL*.

## UPDATE

```sql
UPDATE products SET price = 10 WHERE price = 5;
UPDATE products SET price = price * 10 WHERE price = 1;

/*
Updatea todas las filas donde price sea igual a 5,
Sin el agregado WHERE, todas las filas cambian su price a 10.
*/

/*
En principio luego de WHERE puedo poner cualquier cosa, pero
si quiero actualizar una fila particular, siempre se puede
recurrir a la clave primaria porque es unica.
*/

UPDATE <tabla> SET <atributo> = <expr> WHERE <pk> = <expr>
```

# DELETE

```sql
DELETE FROM <tabla> WHERE <columna> = <expr>

//Ej:
DELETE FROM products WHERE price = 10;
```